# Maps
MAPS=$(wildcard *_map.png)
MAP_UNIQUES=$(patsubst %_map.png, %_uniques.bmp, $(MAPS))
UNIQUES=$(MAP_UNIQUES) status_bar_uniques.bmp

INDECES_RLE_ASM=$(patsubst %_map.png, %_indeces_0_0.tbl.rle.s, $(MAPS))
ATTRIBS_ASM=$(patsubst %_map.png, %_palettes_0_0.attr.s, $(MAPS))
UNIQUES_CHR_ASM=$(patsubst %_uniques.bmp, %_uniques.chr.s, $(UNIQUES))

# Obstructions
OBSIN=$(wildcard *_obs.txt)
OBSOUT_CUT_ASM=$(patsubst %_obs.txt, %_obs_0_0.tbl.s, $(OBSIN))

# Status bar
STATUS_INDECES=status_bar_indeces.tbl.s

# Sprites
WIDGETS_SPRITES=widgets_sprites.chr.s
PLAYER_SPRITES=dreamboy_realworld_day_sprites.chr.s
SPRITES=$(WIDGETS_SPRITES) $(PLAYER_SPRITES)

# Samples
SAMPLES=$(wildcard *.dmc)
SAMPLES_ASM=$(patsubst %.dmc, %.dmc.s, $(SAMPLES))

.PHONY: all
all: $(INDECES_RLE_ASM) $(ATTRIBS_ASM) $(OBSOUT_CUT_ASM) $(UNIQUES_CHR_ASM) $(STATUS_INDECES) $(SPRITES) $(SAMPLES_ASM)

.PHONY: tell
tell:
	echo $(SAMPLES)
	echo $(SAMPLES_ASM)

########
# Maps #
########

%_indeces_0_0.tbl.rle.s: %_indeces_0_0.tbl.rle
	@for Y in `seq 0 3`; do \
		for X in `seq 0 3`; do \
			echo bin2asm $*_indeces_$${X}_$${Y}.tbl.rle -o $*_indeces_$${X}_$${Y}.tbl.rle.s; \
			bin2asm $*_indeces_$${X}_$${Y}.tbl.rle -o $*_indeces_$${X}_$${Y}.tbl.rle.s; \
		done; \
	done

%_indeces_0_0.tbl.rle: %_indeces_0_0.tbl
	@for Y in `seq 0 3`; do \
		for X in `seq 0 3`; do \
			echo bin2asm $*_indeces_$${X}_$${Y}.tbl.rle -o $*_indeces_$${X}_$${Y}.tbl.rle.s; \
			rowrle $*_indeces_$${X}_$${Y}.tbl -o $*_indeces_$${X}_$${Y}.tbl.rle; \
		done; \
	done

%_indeces_0_0.tbl: %_indeces.tbl
	tblcut $< -o $*_indeces_%x_%y.tbl

%_indeces.tbl: %_uniques.bmp
	@echo "($@ already generated by call to uniques...)"

%_palettes_0_0.attr.s: %_palettes_0_0.attr
	@for Y in `seq 0 3`; do \
		for X in `seq 0 3`; do \
			echo bin2asm $*_palettes_$${X}_$${Y}.attr -o $*_palettes_$${X}_$${Y}.attr.s; \
			bin2asm $*_palettes_$${X}_$${Y}.attr -o $*_palettes_$${X}_$${Y}.attr.s; \
		done; \
	done

%_palettes_0_0.attr: %_palettes_0_0.tbl
	@for Y in `seq 0 3`; do \
		for X in `seq 0 3`; do \
			echo tbl2attr $*_palettes_$${X}_$${Y}.tbl -o $*_palettes_$${X}_$${Y}.attr; \
			tbl2attr $*_palettes_$${X}_$${Y}.tbl -o $*_palettes_$${X}_$${Y}.attr; \
		done; \
	done

%_palettes_0_0.tbl: %_palettes.tbl
	tblcut $< -o $*_palettes_%x_%y.tbl

%_palettes.tbl: %_uniques.bmp
	@echo "($@ already generated by call to uniques...)"

%.chr.s: %.chr
	bin2asm $< -o $@

%_uniques.chr: %_uniques.bmp
	img2chr $< -o $@ -p grayscale.png

%_uniques.bmp: %_map.png
	uniques $< -p $(patsubst %_map.png, %_palettes.png, $<) -P grayscale.png -o $@ -a $(patsubst %_map.png, %_palettes.tbl, $<) -t $(patsubst %_map.png, %_indeces.tbl, $<)

################
# Obstructions #
################

%_obs_0_0.tbl.s: %_obs_0_0.tbl
	@for Y in `seq 0 3`; do \
		for X in `seq 0 3`; do \
			echo bin2asm $*_obs_$${X}_$${Y}.tbl -o $*_obs_$${X}_$${Y}.tbl.s; \
			bin2asm $*_obs_$${X}_$${Y}.tbl -o $*_obs_$${X}_$${Y}.tbl.s; \
		done; \
	done

%_obs_0_0.tbl: %_obs.tbl
	tblcut $< -w 8 -h 48 -W 2 -H 12 -o $*_obs_%x_%y.tbl

%_obs.tbl: %_obs.txt
	obs $< -o $@ -w 64 -h 48

##############
# Status Bar #
##############

status_bar_indeces.tbl.s: status_bar_indeces.tbl
	bin2asm $< -o $@

status_bar_indeces.tbl: status_bar_uniques.bmp
	@echo "($@ already generated by call to uniques)"

status_bar_uniques.bmp: status_bar.png status_bar_palette.png grayscale.png
	uniques status_bar.png -o status_bar_uniques.bmp -p status_bar_palette.png -C 1 -P grayscale.png -t status_bar_indeces.tbl -U 18 -W 9 

###########
# Samples #
###########

%.dmc.s: %.dmc
	echo $(SAMPLES)
	echo $(SAMPLES_ASM)
	echo $<
	echo $@
	bin2asm $< -o $@

###########
# Sprites #
###########

%_sprites.chr: %_sprites.bmp grayscale.png
	img2chr -w 1 $< -o $@ -p grayscale.png

dreamboy_realworld_day_sprites.bmp: dreamboy_realworld_day.png realworld_day_sprite_palettes.png grayscale.png
	uniques dreamboy_realworld_day.png -o dreamboy_realworld_day_sprites.bmp -p realworld_day_sprite_palettes.png -P grayscale.png -U 48 -W 8 -w 8 -h 16

widgets_sprites.bmp: widgets.png realworld_day_sprite_palettes.png grayscale.png
	uniques widgets.png -o widgets_sprites.bmp -p realworld_day_sprite_palettes.png -C 4 -P grayscale.png -U 3 -W 3 -w 8 -h 16

.PHONY: clean
clean:
	-rm *.s
	-rm *.rle
	-rm *.tbl
	-rm *.bmp
	-rm *.attr
